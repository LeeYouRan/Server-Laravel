<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>首页 - DNFM内容管理系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.2/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>

        html, body {
            height: 100%;
            margin: 0;
        }

        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://img0.baidu.com/it/u=2979825110,2559091601&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=313');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-color: rgba(255, 255, 255, 0.5); /* Adjust the alpha value to lighten */
            background-blend-mode: lighten; /* Use blend mode to lighten the background */
            z-index: -1;
        }

        .form-group {
            margin-bottom: 20px;
        }
        .table-wrapper {
            overflow-x: auto;
        }
        .modal-body {
            padding-top: 0;
        }
        .pagination {
            justify-content: center;
        }
    </style>
</head>
<body class="background">
<div class="container mt-5">
    <form id="filterForm" class="row g-3">
        <div class="col-md-3">
            <select class="form-select" id="type_id" name="type_id">
                <option value="">选择一级类型</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="second_type_id" name="second_type_id">
                <option value="">选择二级类型</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="grade" name="grade">
                <option value="">选择等级</option>
            </select>
        </div>
        <div class="col-md-3">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" id="title" name="title" placeholder="请输入道具名称">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" id="filter" name="filter" placeholder="名称过滤">
        </div>
 	    <div class="col-md-3">
            <input type="text" class="form-control" id="multiNum" name="multiNum" placeholder="批量发送数量">
        </div>
        <div class="col-md-3">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" id="username" name="username" placeholder="游戏账号" value="">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" id="code" name="code" placeholder="激活码" value="">
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary">搜索</button>
		    <button class="btn btn-secondary btn btn-danger" id="batchSendBtn">批量发送</button>
		    <button class="btn btn-secondary btn btn-warning" id="batchDefaultSendBtn">默认发送</button>
            <button type="reset" class="btn btn-secondary" id="resetDemo">重置</button>
        </div>
    </form>

    <div class="table-wrapper mt-3">
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>等级</th>
                <th>道具名称</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody id="tableBody">
            <!-- Table rows will be appended here -->
            </tbody>
        </table>
    </div>
    <nav>
        <ul class="pagination">
            <!-- Pagination links will be appended here -->
        </ul>
    </nav>
</div>

<div class="modal fade" id="numModal" tabindex="-1" aria-labelledby="numModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="numModalLabel">数量</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="numForm">
                    <div class="mb-3">
                        <label for="num" class="form-label">数量</label>
                        <input type="number" class="form-control" id="num" name="num" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">快速选择</label><br>
                        <input type="radio" name="nums" value="100" class="form-check-input"> 100
                        <input type="radio" name="nums" value="9999" class="form-check-input"> 9999
                        <input type="radio" name="nums" value="999999" class="form-check-input"> 999999
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.2/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const BASE_URL = 'http://local.server-laravel.com';
        const filterForm = document.getElementById('filterForm');
        const tableBody = document.getElementById('tableBody');
        const pagination = document.querySelector('.pagination');
        const numModal = new bootstrap.Modal(document.getElementById('numModal'));
        const numForm = document.getElementById('numForm');
        const batchSendBtn = document.getElementById('batchSendBtn');
        const batchDefaultSendBtn = document.getElementById('batchDefaultSendBtn');
        const resetDemoBtn = document.getElementById('resetDemo');
        let totalTextNode = document.createElement('li');
        totalTextNode.className = `page-item`;
        totalTextNode.innerHTML = '';

        let limitSelect = document.createElement('select');
        limitSelect.id = 'limit';
        limitSelect.setAttribute('hidden', '');
        pagination.appendChild(limitSelect);
        let limitDefaultOption = document.createElement('option');
        limitDefaultOption.value = '';
        limitDefaultOption.textContent = '';
        limitSelect.appendChild(limitDefaultOption);

        let currentPage = 1;
        let totalPages = 1;
        let enumData = {};

        function showMessage(msg,flag) {
            if (flag) {
                showSuccessMessage(msg);
            } else {
                showFailMessage(msg);
            }
        }

        function showSuccessMessage(msg) {
            Swal.fire({
                icon: 'success',
                title: '操作成功',
                text: msg,
                timer: 2000, // 自动关闭时间，单位毫秒
                timerProgressBar: true,
            });
        }

        function showFailMessage(msg) {
            Swal.fire({
                icon: 'error',
                title: '操作失败',
                text: msg,
                timer: 2000, // 自动关闭时间，单位毫秒
                timerProgressBar: true,
            });
        }

        filterForm.addEventListener('submit', function(event) {
            event.preventDefault();
            currentPage = 1;
            fetchData();
        });

       document.getElementById('type_id').addEventListener('change', function() {
            const typeId = this.value;
            if (typeId) {
                fetchSecondTypeOptionsFromSubList(typeId);
            } else {
                renderSecondTypeOptions(transformEnumData(enumData.secondTypeOptions));
            }
        });

        function transformEnumData(enumData) {
            return Object.keys(enumData).map(key => {
                return {
                    id: key,
                    name: enumData[key]
                };
            });
        }

        function fetchEnumData() {
            axios.get(`${BASE_URL}/api/dnf/enum`)
                .then(response => {
                    enumData = response.data.data;
                    renderTypeOptions();
                    renderSecondTypeOptions(transformEnumData(enumData.secondTypeOptions));
                    renderGradeOptions();
                    renderLimitOptions();
                })
                .catch(error => {
                    console.error('Error fetching enum data:', error);
                });
        }

        function fetchSecondTypeOptionsFromSubList(typeId) {
            axios.get(`${BASE_URL}/api/dnf/subList`, { params: { pid: typeId } })
                .then(response => {
                    const secondTypeOptions = response.data.data;
                    renderSecondTypeOptions(secondTypeOptions);
                })
                .catch(error => {
                    console.error('Error fetching second type options from subList:', error);
                });
        }

        function fetchSecondTypeOptions(typeId) {
            axios.get(`${BASE_URL}/api/dnf/enum`)
                .then(response => {
                    const secondTypeOptions = response.data.data.secondTypeOptions;
                    renderSecondTypeOptions(secondTypeOptions, typeId);
                })
                .catch(error => {
                    console.error('Error fetching second type options:', error);
                });
        }

        function fetchData() {
            const params = {
                page: currentPage,
                limit: document.getElementById('limit').value ?? 10,
                title: document.getElementById('title').value,
                filter: document.getElementById('filter').value,
                grade: document.getElementById('grade').value,
                type_id: document.getElementById('type_id').value,
                second_type_id: document.getElementById('second_type_id').value,
            };
            axios.get(`${BASE_URL}/api/dnf/propList`, { params })
                .then(response => {
                    const data = response.data.data.list;
                    const count = response.data.data.count ?? 0;
                    totalPages = Math.ceil(count / 10);
                    renderTable(data);
                    renderPagination();
                    totalTextNode.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault();">总数：${count}</a>`;
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        function renderTypeOptions() {
            const typeSelect = document.getElementById('type_id');
            typeSelect.innerHTML = '<option value="">选择一级类型</option>';
            for (const [value, text] of Object.entries(enumData.firstTypeOptions)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                typeSelect.appendChild(option);
            }
        }

        function renderSecondTypeOptions(secondTypeOptions) {
            const secondTypeSelect = document.getElementById('second_type_id');
            secondTypeSelect.innerHTML = '<option value="">选择二级类型</option>';
            for (const option of secondTypeOptions) {
                const opt = document.createElement('option');
                opt.value = option.id;
                opt.textContent = option.name;
                secondTypeSelect.appendChild(opt);
            }
        }

        function renderGradeOptions() {
            const gradeSelect = document.getElementById('grade');
            gradeSelect.innerHTML = '<option value="">选择等级</option>';
             for (const [value, text] of Object.entries(enumData.gradeOptions)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                gradeSelect.appendChild(option);
            }
        }

        function renderLimitOptions() {
            const limitSelect = document.getElementById('limit');
            limitSelect.innerHTML = '<option value="">单页条数</option>';
            for (const [value, text] of Object.entries(enumData.limitOptions)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                limitSelect.appendChild(option);
            }
            // 添加 change 事件监听器
            limitSelect.addEventListener('change', function() {
                fetchData(); // 在下拉框选项改变时调用 test() 方法
            });
        }

        // function renderTable(data) {
        //     tableBody.innerHTML = '';
        //     data.forEach(item => {
        //         const row = document.createElement('tr');
        //         row.innerHTML = `
        //             <td>${item.grade}</td>
        //             <td>${item.title}</td>
        //             <td><button class="btn btn-sm btn-primary select-btn" data-id="${item.id}" data-title="${item.title}" data-grade="${item.grade}">选择</button></td>
        //         `;
        //         tableBody.appendChild(row);
        //     });
        //     attachSelectEvent();
        // }


        function renderTable(data) {
            tableBody.innerHTML = '';
            if(data){
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td style="width: 300px;">${item.grade}</td>
                    <td style="width: 300px;">${item.title}</td>
                    <td style="white-space: nowrap;width: 300px;">
                        <input id="num-${item.id}" type="number" class="form-control form-control-sm mb-1" placeholder="数量" style="width: 150px; display: inline-block;" data-id="${item.id}">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="numOptions-${item.id}" value="100"> 100
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="numOptions-${item.id}" value="9999"> 9999
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="numOptions-${item.id}" value="999999"> 999999
                        </div>
                        <button class="btn btn-primary btn-sm send-btn" data-id="${item.id}">发送</button>
                    </td>
                `;
                    tableBody.appendChild(row);
                });
            }
            attachSelectTableEvent();
            attachSendBtnListeners();
        }

        function attachSelectTableEvent() {
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    const id = this.name.split('-')[1];
                    const quantityInput = document.getElementById(`num-${id}`);
                    quantityInput.value = this.value;
                });
            });
        }

        function attachSendBtnListeners() {
            const sendBtns = document.querySelectorAll('.send-btn');
            sendBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const quantityInput = document.querySelector(`input[type="number"][data-id="${id}"]`);
                    const quantity = quantityInput ? (quantityInput.value ? quantityInput.value : 1) : 0;
                    const selectedRadio = document.querySelector(`input[name="numOptions-${id}"]:checked`);
                    const selectedValue = selectedRadio ? selectedRadio.value : null;

                    if (!quantity && !selectedValue) {
                        // alert('请输入数量或选择一个数量选项');
                        showMessage('请输入数量或选择一个数量选项',false);
                        return;
                    }

                    const username = document.getElementById('username').value;
                    const code = document.getElementById('code').value;

                    if(!username || !code){
                        // alert('用户名和激活码都不能为空');
                        showMessage('用户名和激活码都不能为空',false);
                        return;
                    }

                    const data = {
                        username: username,
                        code: code,
                        id: id,
                        num: quantity,
                        numOption: selectedValue
                    };

                    axios.post(`${BASE_URL}/api/dnf/propNum`, data)
                        .then(response => {
                            // alert(response.data.msg);
                            if(!response.data.code){
                                showMessage(response.data.msg,false);
                            }else{
                                showMessage(response.data.msg,true);
                            }
                        })
                        .catch(error => {
                            console.error('发送失败:', error);
                            // alert('发送失败，请重试');
                            showMessage('发送失败，请重试',false);
                        });
                });
            });
        }

        function renderPagination() {
            pagination.innerHTML = '';

            const maxPagesToShow = 10;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = startPage + maxPagesToShow - 1;

            if (endPage > totalPages) {
                endPage = totalPages;
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            // Create first page button
            const firstPageLi = document.createElement('li');
            firstPageLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            firstPageLi.innerHTML = `<a class="page-link" href="#">首页</a>`;
            firstPageLi.addEventListener('click', function() {
                if (currentPage !== 1) {
                    currentPage = 1;
                    fetchData();
                }
            });
            pagination.appendChild(firstPageLi);

            // Create previous page button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#">上一页</a>`;
            prevLi.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    fetchData();
                }
            });
            pagination.appendChild(prevLi);

            // Create page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', function() {
                    if (i !== currentPage) {
                        currentPage = i;
                        fetchData();
                    }
                });
                pagination.appendChild(li);
            }

            // Create next page button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#">下一页</a>`;
            nextLi.addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    fetchData();
                }
            });
            pagination.appendChild(nextLi);

            // Create last page button
            const lastPageLi = document.createElement('li');
            lastPageLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            lastPageLi.innerHTML = `<a class="page-link" href="#">尾页</a>`;
            lastPageLi.addEventListener('click', function() {
                if (currentPage !== totalPages) {
                    currentPage = totalPages;
                    fetchData();
                }
            });
            pagination.appendChild(lastPageLi);

            // 将文本节点添加到 pagination 中
            limitSelect.removeAttribute('hidden');
            pagination.appendChild(totalTextNode);
            pagination.appendChild(limitSelect);
        }

        function attachSelectEvent() {
            document.querySelectorAll('.select-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const title = this.dataset.title;
                    const grade = this.dataset.grade;

                    numForm.dataset.id = id;
                    numForm.dataset.title = title;
                    numForm.dataset.grade = grade;

                    numModal.show();
                });
            });
        }

        numForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const id = this.dataset.id;
            const num = document.getElementById('num').value;
            const username = document.getElementById('username').value;
            const code = document.getElementById('code').value;

            if(!username || !code){
                // alert('用户名和激活码都不能为空');
                showMessage('用户名和激活码都不能为空',false);
                return;
            }

            axios.post(`${BASE_URL}/api/dnf/propNum`, {
                username,
                code,
                id,
                num
            })
            .then(response => {
                // alert(response.data.msg);
                if(!response.data.code){
                    showMessage(response.data.msg,false);
                }else{
                    showMessage(response.data.msg,true);
                }
                numModal.hide();
            })
            .catch(error => {
                console.error('Error sending prop:', error);
            });
        });

        resetDemoBtn.addEventListener('click', function() {
            document.getElementById('limit').value = '10';
            document.getElementById('title').value = '';
            document.getElementById('filter').value = '';
            document.getElementById('grade').value = '';
            document.getElementById('type_id').value = '';
            document.getElementById('second_type_id').value = '';
            fetchData();
        });

        batchSendBtn.addEventListener('click', function() {
                const username = document.getElementById('username').value;
                const code = document.getElementById('code').value;
                const type_id = document.getElementById('type_id').value;
                const second_type_id = document.getElementById('second_type_id').value;
                const title = document.getElementById('title').value;
		        const multiNum = document.getElementById('multiNum').value;
		        const filter = document.getElementById('filter').value;
                if(!type_id){
                    // alert('一级类型必选');
                    showMessage('一级类型必选',false);
                    return;
                }
                axios.post(`${BASE_URL}/api/dnf/multiSend`, {
                    username,
                    code,
                    type_id,
                    second_type_id,
                    page: 1,
                    limit: 10000,
                    title,
		            num:multiNum,
                    filter,
                })
            .then(response => {
                // alert(response.data.msg);
                showMessage(response.data.msg,false);
            })
            .catch(error => {
                console.error('Error batch sending props:', error);
            });
        });

        batchDefaultSendBtn.addEventListener('click', function() {
                const username = document.getElementById('username').value;
                const code = document.getElementById('code').value;
                const type_id = document.getElementById('type_id').value;
                const second_type_id = document.getElementById('second_type_id').value;
                const title = document.getElementById('title').value;
		        const multiNum = document.getElementById('multiNum').value;
		        const filter = document.getElementById('filter').value;

                axios.post(`${BASE_URL}/api/dnf/multiDefaultSend`, {
                    username,
                    code,
                    type_id,
                    second_type_id,
                    page: 1,
                    limit: 10000,
                    title,
		            num:multiNum,
                    filter,
                })
            .then(response => {
                // alert(response.data.msg);
                showMessage(response.data.msg,true);
            })
            .catch(error => {
                console.error('Error batch sending props:', error);
            });
        });

        document.querySelectorAll('input[name="nums"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('num').value = this.value;
            });
        });


        fetchEnumData();
        fetchData();
    });
</script>
</body>
</html>
